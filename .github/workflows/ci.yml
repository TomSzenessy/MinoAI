# Mino CI/CD Pipeline
#
# This workflow:
# 1. Runs on every push to main and pull requests
# 2. Installs dependencies and builds all packages
# 3. Runs tests and linting
# 4. Builds Docker images and pushes to GHCR
# 5. Deploys web app to Cloudflare Pages

name: CI/CD

on:
    push:
        branches: [main]
        tags: ['v*']
    pull_request:
        branches: [main]

env:
    REGISTRY: ghcr.io
    IMAGE_NAME_SERVER: ${{ github.repository_owner }}/mino-server
    IMAGE_NAME_RELAY: ${{ github.repository_owner }}/mino-relay

jobs:
    # ===========================================================================
    # Build and Test
    # ===========================================================================
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v3

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build packages
              run: pnpm build

            - name: Run tests
              run: pnpm test

            - name: Type check
              run: pnpm typecheck

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: build-artifacts
                  path: |
                      apps/server/dist
                      apps/web/.next
                      apps/relay/dist
                      packages/shared/dist
                      packages/design-tokens/dist
                  retention-days: 1

    # ===========================================================================
    # Docker Build and Push (Server)
    # ===========================================================================
    docker-server:
        needs: build
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: build-artifacts

            - name: Set up QEMU for multi-arch builds
              uses: docker/setup-qemu-action@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata for Docker
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_SERVER }}
                  tags: |
                      type=ref,event=branch
                      type=semver,pattern={{version}}
                      type=semver,pattern={{major}}.{{minor}}
                      type=sha,prefix=

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: docker/Dockerfile
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  platforms: linux/amd64,linux/arm64
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

    # ===========================================================================
    # Docker Build and Push (Relay)
    # ===========================================================================
    docker-relay:
        needs: build
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up QEMU for multi-arch builds
              uses: docker/setup-qemu-action@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata for Docker
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_RELAY }}
                  tags: |
                      type=ref,event=branch
                      type=semver,pattern={{version}}
                      type=semver,pattern={{major}}.{{minor}}
                      type=sha,prefix=

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: docker/Relay.Dockerfile
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  platforms: linux/amd64,linux/arm64
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

    # ===========================================================================
    # Deploy Web to Cloudflare Pages
    # ===========================================================================
    deploy-web:
        needs: build
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: build-artifacts

            - name: Setup pnpm
              uses: pnpm/action-setup@v3

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22'
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build web app for Cloudflare Pages
              run: cd apps/web && pnpm build
              env:
                  NEXT_PUBLIC_MINO_ENV: production

            - name: Deploy to Cloudflare Pages
              uses: cloudflare/pages-action@v1
              with:
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                  projectName: mino-ink
                  directory: apps/web/out
                  gitHubToken: ${{ secrets.GITHUB_TOKEN }}

    # ===========================================================================
    # Create Release
    # ===========================================================================
    release:
        needs: [docker-server, docker-relay]
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/v')
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Extract version from tag
              id: version
              run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

            - name: Generate changelog
              id: changelog
              run: |
                  # Get previous tag
                  PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
                  if [ -n "$PREV_TAG" ]; then
                    CHANGELOG=$(git log $PREV_TAG..HEAD --oneline --no-merges)
                  else
                    CHANGELOG=$(git log --oneline --no-merges -20)
                  fi
                  echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
                  echo "$CHANGELOG" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  name: Mino v${{ steps.version.outputs.VERSION }}
                  body: |
                      ## What's Changed

                      ${{ steps.changelog.outputs.CHANGELOG }}

                      ## Docker Images

                      - Server: `ghcr.io/${{ github.repository_owner }}/mino-server:${{ steps.version.outputs.VERSION }}`
                      - Relay: `ghcr.io/${{ github.repository_owner }}/mino-relay:${{ steps.version.outputs.VERSION }}`

                      ## Quick Start

                      ```bash
                      curl -fsSL https://mino.ink/docker-compose.yml -o docker-compose.yml
                      docker compose up -d
                      ```
                  draft: false
                  prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}
