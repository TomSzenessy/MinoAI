# =============================================================================
# Mino Relay — Docker Compose (Portainer-friendly)
#
# Usage:
#   docker compose -f docker/relay-docker-compose.yml up -d
#
# Copy-paste this file into Portainer → Stacks → "Add Stack" → Paste YAML
# to deploy the relay as a standalone stack.
#
# The relay enables private Mino servers to be accessible via mino.ink
# without requiring open inbound ports. Servers connect outbound to the
# relay, and the web client proxies requests through it.
#
# After deploying:
#   1. Route relay.test.mino.ink (or relay.mino.ink) to the relay container
#      via Cloudflare Tunnel or reverse proxy.
#   2. Verify: GET https://relay.test.mino.ink/api/v1/health
#   3. Set NEXT_PUBLIC_RELAY_URL on Cloudflare Pages and redeploy.
#   4. Deploy the Mino server stack with MINO_RELAY_URL pointing here.
#
# See docs/relay.md for the full deployment guide.
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Mino Relay — WebSocket proxy for private server connectivity
  # ---------------------------------------------------------------------------
  relay:
    image: ghcr.io/tomszenessy/mino-relay:${RELAY_IMAGE_TAG:-main}
    container_name: mino-relay
    restart: unless-stopped
    ports:
      - "${RELAY_PORT_BIND:-0.0.0.0}:${RELAY_PORT:-8787}:8787"
    environment:
      - NODE_ENV=production
      - RELAY_PORT=8787
      - RELAY_HOST=0.0.0.0
      # Public URL that clients and servers use to reach this relay.
      # Must match the domain routed to this container.
      - RELAY_PUBLIC_BASE_URL=${RELAY_PUBLIC_BASE_URL:-https://relay.mino.ink}
    healthcheck:
      test:
        [
          "CMD",
          "bun",
          "-e",
          "fetch('http://127.0.0.1:8787/api/v1/health').then((r)=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))",
        ]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
