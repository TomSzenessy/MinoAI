# =============================================================================
# Mino Server — Docker Compose (Portainer-friendly)
#
# Usage:
#   docker compose up -d                           — Relay mode (default, no tunnel)
#   docker compose --profile tunnel up -d          — Start with Cloudflare Tunnel
#   docker compose --profile autoupdate up -d      — Start with Watchtower auto-updates
#
# Copy-paste this file into Portainer → Stacks → "Add Stack" → Paste YAML.
# =============================================================================

services:
  # -------------------------------------------------------------------------
  # Mino Server — The core API + built-in web UI
  # -------------------------------------------------------------------------
  mino:
    # Default to :main so fresh pushes are always pullable.
    # Override with MINO_IMAGE_TAG=latest (or a pinned version tag) if desired.
    image: ghcr.io/tomszenessy/mino-server:${MINO_IMAGE_TAG:-main}
    container_name: mino-server
    restart: unless-stopped
    ports:
      # Relay mode default: local-only bind
      # Open-port mode: set MINO_PORT_BIND=0.0.0.0
      - "${MINO_PORT_BIND:-127.0.0.1}:${MINO_PORT:-3000}:3000"
    volumes:
      - mino-data:/data
    environment:
      - NODE_ENV=production
      - MINO_DATA_DIR=/data
      - MINO_CONNECTION_MODE=${MINO_CONNECTION_MODE:-relay}
      - MINO_RELAY_URL=${MINO_RELAY_URL:-https://relay.mino.ink}
      - MINO_PUBLIC_SERVER_URL=${MINO_PUBLIC_SERVER_URL:-}
      # Optional overrides (uncomment as needed):
      # - MINO_PORT=3000
      # - MINO_PORT_BIND=0.0.0.0
      # - MINO_HOST=0.0.0.0
      # - MINO_CONNECTION_MODE=relay|open-port
      # - MINO_RELAY_URL=https://relay.mino.ink
      # - MINO_PUBLIC_SERVER_URL=https://api.yourdomain.com
      # - MINO_AUTH_MODE=api-key
      # - MINO_CORS_ORIGINS=https://mino.ink,https://test.mino.ink,http://localhost:3000
      # - MINO_AGENT_ENABLED=true
      # - MINO_AGENT_PROVIDER=anthropic
      # - MINO_AGENT_MODEL=claude-sonnet-4-20250514
      # - MINO_AGENT_API_KEY=sk-ant-...
      # - MINO_LOG_LEVEL=info
    healthcheck:
      test:
        [
          "CMD",
          "bun",
          "-e",
          "fetch('http://127.0.0.1:3000/api/v1/health').then((r)=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))",
        ]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3

  # -------------------------------------------------------------------------
  # Cloudflare Tunnel — Secure remote access (no open ports)
  # Activate with: docker compose --profile tunnel up -d
  #
  # Only starts when the "tunnel" profile is active.
  # Requires CF_TUNNEL_TOKEN to be set in Portainer env vars.
  #
  # Get your tunnel token from: https://one.dash.cloudflare.com
  # Networks/Tunnels -> Create tunnel -> Cloudflared
  # Copy token from the shown docker command: `... --token <TOKEN>`
  # -------------------------------------------------------------------------
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: mino-tunnel
    restart: unless-stopped
    profiles: ["tunnel"]
    command: tunnel --no-autoupdate run --token ${CF_TUNNEL_TOKEN}
    depends_on:
      mino:
        condition: service_started

  # -------------------------------------------------------------------------
  # Watchtower — Automatic Docker image updates from GHCR
  # Activate with: docker compose --profile autoupdate up -d
  #
  # Checks for new images every 6 hours. Zero-downtime restarts.
  # -------------------------------------------------------------------------
  watchtower:
    image: containrrr/watchtower:latest
    container_name: mino-watchtower
    restart: unless-stopped
    profiles: ["autoupdate"]
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=21600    # 6 hours
      - WATCHTOWER_INCLUDE_STOPPED=false
      - WATCHTOWER_SCOPE=mino
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    labels:
      - "com.centurylinklabs.watchtower.scope=mino"

volumes:
  mino-data:
    name: mino-data
