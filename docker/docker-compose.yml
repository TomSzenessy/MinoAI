# =============================================================================
# Mino Server — Docker Compose (Portainer-friendly)
#
# Usage:
#   docker compose up -d                           — Open mode (default, published port)
#   docker compose --profile tunnel up -d          — Tunnel mode (recommended safer mode)
#   docker compose --profile autoupdate up -d      — Start server + Watchtower
#   docker compose --profile full up -d            — Start everything
#
# Copy-paste this file into Portainer → Stacks → "Add Stack" → Paste YAML.
# =============================================================================

services:
  # -------------------------------------------------------------------------
  # Mino Server — The core API + built-in web UI
  # -------------------------------------------------------------------------
  mino:
    image: ghcr.io/tomszenessy/mino-server:latest
    container_name: mino-server
    restart: unless-stopped
    ports:
      # Open mode default: MINO_PORT_BIND=0.0.0.0 (public on host)
      # Safer tunnel mode: MINO_PORT_BIND=127.0.0.1 (local-only bind)
      - "${MINO_PORT_BIND:-0.0.0.0}:${MINO_PORT:-3000}:3000"
    volumes:
      - mino-data:/data
    environment:
      - NODE_ENV=production
      - MINO_DATA_DIR=/data
      # Optional overrides (uncomment as needed):
      # - MINO_PORT=3000
      # - MINO_PORT_BIND=0.0.0.0
      # - MINO_HOST=0.0.0.0
      # - MINO_AUTH_MODE=api-key
      # - MINO_CORS_ORIGINS=https://mino.ink,https://test.mino.ink,http://localhost:3000
      # - MINO_AGENT_ENABLED=true
      # - MINO_AGENT_PROVIDER=anthropic
      # - MINO_AGENT_MODEL=claude-sonnet-4-20250514
      # - MINO_AGENT_API_KEY=sk-ant-...
      # - MINO_LOG_LEVEL=info
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/v1/health"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3

  # -------------------------------------------------------------------------
  # Cloudflare Tunnel — Secure remote access (no open ports)
  # Activate with: docker compose --profile tunnel up -d
  # Recommended with tunnel mode:
  #   MINO_PORT_BIND=127.0.0.1 (avoid exposing host port externally)
  #
  # Get your tunnel token from: https://one.dash.cloudflare.com
  # Networks/Connectors -> Add a tunnel -> Cloudflared or WARP connector
  # Copy token from the shown docker command: `... --token <TOKEN>`
  # -------------------------------------------------------------------------
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: mino-tunnel
    restart: unless-stopped
    profiles: ["tunnel", "full"]
    command: tunnel --no-autoupdate run
    environment:
      # Keep optional so base stack deploys without tunnel config.
      # When enabling the tunnel profile, set CF_TUNNEL_TOKEN in Portainer env vars.
      - TUNNEL_TOKEN=${CF_TUNNEL_TOKEN:-}
    depends_on:
      mino:
        condition: service_healthy

  # -------------------------------------------------------------------------
  # Watchtower — Automatic Docker image updates from GHCR
  # Activate with: docker compose --profile autoupdate up -d
  #
  # Checks for new images every 6 hours. Zero-downtime restarts.
  # -------------------------------------------------------------------------
  watchtower:
    image: containrrr/watchtower:latest
    container_name: mino-watchtower
    restart: unless-stopped
    profiles: ["autoupdate", "full"]
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=21600    # 6 hours
      - WATCHTOWER_INCLUDE_STOPPED=false
      - WATCHTOWER_SCOPE=mino
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    labels:
      - "com.centurylinklabs.watchtower.scope=mino"

volumes:
  mino-data:
    name: mino-data
